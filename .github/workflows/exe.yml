
name: Build quickjs on Windows

on: [push, pull_request]

jobs:
  build:
    name: MinGW Windows target
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install MinGW and Wine
        run: |
          sudo apt update
          sudo apt install -y wine mingw-w64
          cp /usr/x86_64-w64-mingw32/lib/libwinpthread-1.dll .
      - name: Setup Wine
        run: |
          wine --version
          winecfg /v
          # binfmt doesn't work in GitHub Actions
          #sudo apt install -y binfmt-support wine-binfmt
          #echo ":Wine:M::MZ::/usr/bin/wine:" > /etc/binfmt.d/wine.conf
          #sudo systemctl restart systemd-binfmt
      - name: Build
        run: |
          make CONFIG_WIN32=y
      - name: Run built-in tests
        run: |
          # If binfmt support worked, could just run `make CONFIG_WIN32=y test`
          make WINE=/usr/bin/wine CONFIG_WIN32=y test
      - name: List build results
        run: |
          ls -l .
      
      - name: Upload all build files
        uses: actions/upload-artifact@v4
        with:
          name: quickjs-windows-artifacts
          path: ./*.exe
